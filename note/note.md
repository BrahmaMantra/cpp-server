## Epoll和epoll_event
- Epoll 是一个封装了 epoll 系统调用的类，用于管理和监控多个文件描述符上的事件。（自己封装的，原本就是一个fd）
- epoll_event 是一个结构体，用于描述文件描述符上的事件。(是c++库提供的)
### 关系描述
- Epoll 类通常会包含一个 epoll 文件描述符，和一个epoll_event的数组，用来管理这些epoll_event
- epoll_event 结构体用于描述具体的事件，包括文件描述符和事件类型。（理解成一个事件）

## 什么时候事件驱动会有响应？
在事件驱动模型中，服务器使用epoll_wait来等待事件。当以下情况发生时，epoll_wait会有响应：
- 新连接到达：当有新的客户端连接请求到达服务器的监听套接字时，监听套接字会变为可读状态。此时，epoll_wait返回，服务器可以调用accept函数接受新的连接，并为新连接创建一个新的套接字。
- 客户端发送数据：当已连接的客户端发送数据到服务器时，客户端套接字会变为可读状态。此时，epoll_wait返回，服务器可以读取客户端发送的数据。
- 客户端关闭连接：当客户端关闭连接时，客户端套接字会变为可读状态，并且读取操作会返回0，表示连接已关闭。此时，epoll_wait返回，服务器可以关闭相应的套接字并清理资源。
- 错误事件：当套接字上发生错误（如连接重置、网络不可达等）时，套接字会变为可读或可写状态，并且epoll_event结构中的events字段会包含错误标志。此时，epoll_wait返回，服务器可以处理相应的错误。  
  
总结来说，服务器在以下情况下会导致epoll_wait有响应：

- 新连接请求到达
- 客户端发送数据
- 客户端关闭连接
- 套接字发生错误
这些事件会触发epoll_wait返回，服务器可以根据事件类型进行相应的处理。

## epoll_wait
就绪链表+红黑树，阻塞
## 惊群效应简介
所谓惊群效应，就是多个进程或者线程在等待同一个事件，当事件发生时，所有进程或者线程都会被内核唤醒。然后，通常只有一个进程获得了该事件，并进行处理；其他进程在发现获取事件失败后，又继续进入了等待状态。这在一定程度上降低了系统性能。具体来说，惊群通常发生在服务器的监听等待调用上。服务器创建监听socket，然后fork多个进程，在每个进程中调用accept或者epoll_wait等待终端的连接。

- 在高并发（多线程/多进程/多连接）中，会产生惊群的情况有：
    - accept惊群
    - epoll惊群(想想1/10 sleep())
    - nginx惊群
    - 线程池惊群

### accept惊群(新版内核已解决)
以多进程为例，在主进程创建监听描述符listenfd后，fork多个子进程，多个进程共享listenfd，accept是在每个子进程中，当一个新连接来的时候，会发生惊群。  

在内核2.6之前，所有进程accept都会惊醒，但只有一个可以accept成功，其他返回EGAIN。在内核2.6及之后，解决了惊群问题，在内核中增加了一个互斥等待变量EXCLUSEVE。一个互斥等待行为与睡眠基本类似，主要的不同点在于：

1）当一个进程有WQ_FLAG_EXCLUSEVE标志置位，它被添加到等待队列的尾部。若没有这个标志置位，则添加到队列首部。

2）当wake_up被在一个等待队列上调用时，它在唤醒第一个有WQ_FLAG_EXCLUSIVE标志的进程后停止。

对于互斥等待的行为，比如对一个listen后的socket描述符，多线程阻塞accept时，系统内核只会唤醒所有正在等待此时间的队列中的第一个进程/线程，队列中的其他进程/线程则继续等待下一次事件的发生。这样，就避免了多个进程/线程同时监听同一个socket描述符时的惊群问题。

## 有道理的几句话
当网卡接收到数据时，数据中一定会带着端口号，内核就可以找到对应的 socket，并从中取得“挂起”进程的 ID。将进程的状态修改为“可运行状态”（加入到工作队列）。此时内核代码执行完毕，将控制权交还给用户态。通过正常的“CPU 时间片的调度”，用户进程得以处理数据。

换句话说，阻塞不是问题，运行才是问题，运行才会消耗 CPU。IO 多路复用不是减少了阻塞，是减少了运行。上下文切换才是问题，IO 多路复用，通过减少运行的进程，有效的减少了上下文切换。
## 遇到的坑点：
1. bzero(events, sizeof(*events) * MAX_EVENTS)和bzero(&events, sizeof(*events) * MAX_EVENTS);前者会让这个指针变成空指针，后者才是清空指定范围内存


## 可以参考
- [初识Epoll概述]https://zhuanlan.zhihu.com/p/448034877  

- [超强源码分析](https://zhuanlan.zhihu.com/p/9584765213)
- [惊群效应](https://zhuanlan.zhihu.com/p/648182336)